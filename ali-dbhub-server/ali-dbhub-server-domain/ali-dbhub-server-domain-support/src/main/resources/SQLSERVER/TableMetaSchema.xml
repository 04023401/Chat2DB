<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.alibaba.dbhub.server.domain.support.dialect.sqlserver.mapper.SqlServerMetaSchemaMapper">
    <resultMap id="BaseTableResultMap" type="com.alibaba.dbhub.server.domain.support.model.Table">
        <result property="name" jdbcType="CHAR" column="table_name"/>
        <result property="comment" jdbcType="CHAR" column="table_comment"/>
    </resultMap>
    <resultMap id="BaseTableColumnResultMap" type="com.alibaba.dbhub.server.domain.support.model.TableColumn">
        <result property="name" jdbcType="CHAR" column="COLUMN_NAME"/>
        <result property="tableName" jdbcType="CHAR" column="TABLE_NAME"/>
        <result property="comment" jdbcType="CHAR" column="COLUMN_COMMENT"/>
        <result property="columnType" jdbcType="CHAR" column="COLUMN_TYPE"/>
        <result property="dataType" jdbcType="CHAR" column="DATA_TYPE"/>
        <result property="defaultValue" jdbcType="CHAR" column="COLUMN_DEFAULT"/>
        <result property="nullable" jdbcType="CHAR" column="IS_NULLABLE"
                typeHandler="com.alibaba.dbhub.server.domain.support.dialect.common.handler.BooleanTypeHandler"/>
        <result property="autoIncrement" jdbcType="CHAR" column="EXTRA"
                typeHandler="com.alibaba.dbhub.server.domain.support.dialect.mysql.handler.MysqlExtraTypeHandler"/>
        <result property="primaryKey" jdbcType="CHAR" column="COLUMN_KEY"
                typeHandler="com.alibaba.dbhub.server.domain.support.dialect.mysql.handler.MysqlColumnKeyHandler"/>
        <result property="precision" jdbcType="INTEGER" column="numeric_precision"/>
        <result property="scale" jdbcType="INTEGER" column="numeric_scale"/>
        <result property="ordinalPosition" jdbcType="INTEGER" column="ordinal_position"/>
    </resultMap>
    <resultMap id="TableIndexColumnUnionResultMap"
               type="com.alibaba.dbhub.server.domain.support.model.TableIndexColumn">
        <result property="indexName" jdbcType="CHAR" column="INDEX_NAME"/>
        <result property="tableName" jdbcType="CHAR" column="TABLE_NAME"/>
        <result property="columnName" jdbcType="CHAR" column="COLUMN_NAME"/>
        <result property="collation" jdbcType="CHAR" column="COLLATION"
                typeHandler="com.alibaba.dbhub.server.domain.support.dialect.mysql.handler.MysqlCollationTypeHandler"/>
        <result property="ordinalPosition" jdbcType="CHAR" column="SEQ_IN_INDEX"/>
        <result property="type" jdbcType="CHAR" column="NON_UNIQUE"
                typeHandler="com.alibaba.dbhub.server.domain.support.dialect.mysql.handler.MysqlIndexTypeHandler"/>
        <result property="comment" jdbcType="CHAR" column="INDEX_COMMENT"/>
    </resultMap>

    <select id="showDatabases" resultType="java.lang.String">
        select SCHEMA_NAME from INFORMATION_SCHEMA.SCHEMATA;
    </select>

    <select id="showCreateTable" resultType="java.lang.String">
        select tabledef(#{tableName,jdbcType=VARCHAR}::regclass);
    </select>
    <update id="dropTable">
        drop table ${databaseName}.${tableName};
    </update>

    <select id="selectTableCount" resultType="java.lang.Integer">
        SELECT count(*)
        FROM sys.TABLES
        where schema_id = #{databaseName};
    </select>

    <select id="selectTables" resultMap="BaseTableResultMap">
        select t.name as table_name , ep.value as table_comment
        from sys.tables t left join sys.extended_properties ep on (t.object_id = ep.major_id AND ep.minor_id =
        0), sys.schemas s where t.schema_id = s.schema_id and s.name = #{databaseName} and t.name = #{tableName};

    </select>

    <select id="selectColumns" resultMap="BaseTableColumnResultMap">
        select c.ORDINAL_POSITION as ordinal_position,
        c.COLUMN_NAME as COLUMN_NAME,
        c.DATA_TYPE as DATA_TYPE,
        c.CHARACTER_MAXIMUM_LENGTH as Length,
        c.NUMERIC_SCALE as scale,
        c.NUMERIC_PRECISION as numeric_precision,
        c.IS_NULLABLE as IS_NULLABLE,
        sc.is_identity as COLUMN_KEY,
        c.COLUMN_DEFAULT as COLUMN_DEFAULT,
        c.COLLATION_NAME as collation_name,
        ep.value as COLUMN_COMMENT
        from
        INFORMATION_SCHEMA.COLUMNS c left join sys.columns sc on
        (sc.object_id = object_id(c.TABLE_NAME) and sc.name = c.COLUMN_NAME ) left join sys.extended_properties ep on
        (sc.object_id = ep.major_id AND sc.column_id = ep.minor_id)
        where c.TABLE_NAME = #{tableName} and
        c.TABLE_CATALOG = #{databaseName} and
        c.TABLE_SCHEMA = #{schemaName} ;
    </select>

    <select id="selectTableIndexes" resultMap="TableIndexColumnUnionResultMap">
        SELECT    idx.name AS INDEX_NAME,
        col.name AS COLUMN_NAME,
        tab.name AS TABLE_NAME,
        idx.type_desc as INDEX_COMMENT,
        idxCol.is_descending_key as is_descending_key,
        idxCol.is_included_column as is_included_column,
        idx.is_unique as NON_UNIQUE
        FROM    sys.indexes idx  JOIN sys.index_columns idxCol
        ON    (idx.object_id = idxCol.object_id      AND idx.index_id = idxCol.index_id      AND idx.is_unique_constraint = 0      and is_primary_key = 0)  JOIN sys.tables tab          ON    (idx.object_id = tab.object_id)  JOIN sys.columns col          ON    (idx.object_id = col.object_id      AND idxCol.column_id = col.column_id)
        WHERE    tab.name = #{tableName};
    </select>
</mapper>